
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4. Attention Layers &#8212; Deep Learning for Molecules and Materials</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/a11y.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/custom.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="3. Graph Neural Networks" href="gnn.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Deep Learning for Molecules and Materials</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Deep Learning for Molecules and Materials
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  A. Math Review
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../math/tensors-and-shapes.html">
   1. Tensors and Shapes
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  B. Machine Learning
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../ml/introduction.html">
   1. Introduction to Machine Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml/regression.html">
   2. Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ml/classification.html">
   3. Classification
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  C. Deep Learning
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   1. Introduction to Deep Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="layers.html">
   2. Standard Layers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gnn.html">
   3. Graph Neural Networks
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4. Attention Layers
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Made with <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/dl/attention.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/whitead/dmol-book/master?urlpath=tree/dl/attention.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/whitead/dmol-book/blob/master/dl/attention.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   4.1. Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#attention-mechanism-equation">
   4.2. Attention Mechanism Equation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#attention-reduction">
   4.3. Attention Reduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#soft-vs-hard-attention">
   4.4. Soft vs Hard Attention
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tensor-dot">
   4.5. Tensor-Dot
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#self-attention">
   4.6. Self-Attention
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#trainable-attention">
   4.7. Trainable Attention
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-head-attention-block">
   4.8. Multi-head Attention Block
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#attention-in-graph-neural-networks">
   4.9. Attention in Graph Neural Networks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cited-references">
   4.10. Cited References
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="attention-layers">
<h1><span class="section-number">4. </span>Attention Layers<a class="headerlink" href="#attention-layers" title="Permalink to this headline">¶</a></h1>
<p>Attention is a concept in machine learning and AI that goes back many years, especially in computer vision<a class="bibtex reference internal" href="layers.html#baluja1997329" id="id1">[BP97]</a>. Like the word “neural network”, attention was inspired by the idea of attention in how human brains deal with the massive amount of visual and audio input<a class="bibtex reference internal" href="layers.html#treisman1980feature" id="id2">[TG80]</a>. <strong>Attention layers</strong> are deep learning layers that evoke the idea of attention. You can read more about attention in deep learning in Luong et al. <a class="bibtex reference internal" href="layers.html#luong2015effective" id="id3">[LPM15]</a> and get a practical <a class="reference external" href="http://d2l.ai/chapter_attention-mechanisms/index.html">overview here</a>. Attention layers have been empirically shown to be so effective in modeling sequences, like language, that they have become indispensible<a class="bibtex reference internal" href="layers.html#vaswani2017attention" id="id4">[VSP+17]</a>. The most common place you’ll see attention layers is in <a class="reference external" href="http://d2l.ai/chapter_attention-mechanisms/transformer.html"><strong>transformers</strong></a> neural networks that model sequences. We’ll also see attention in graph neural networks and they are common in computer vision.</p>
<p>Attention layers are fundamentally a weighted mean reduction. Attention removes one axis from an input tensor by computing a mean. Attention is unusal among layers because it takes three inputs, whereas most layers in deep learning take just one or perhaps two. These inputs are called the <strong>query</strong>, the <strong>values</strong>, and the <strong>keys</strong>. The reduction occurs over the values; so if the values are rank 3, the output will be rank 2. The query should be one less rank than
the keys. The keys should be the same rank as the values. The keys and query determine how to weight the values.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Attention can be confusing because of the three inputs. We’ll see later though that these inputs are actually often identical. The query is one key and the keys and values are equal. Then if you batch the queries together (one for each key), then you’ll see the query, keys, and values are equal. This is self-attention.</p>
</div>
<p>The table below summarizes these three input arguments. Note that often the query is batched, so that it’s rank will be 2 if batched and the output’s rank will be 2.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="head"><p>Rank</p></th>
<th class="head"><p>Axes</p></th>
<th class="head"><p>Purpose</p></th>
<th class="text-align:right head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Query</p></td>
<td><p>1</p></td>
<td><p>(# of attn features)</p></td>
<td><p>input for checking against keys</p></td>
<td class="text-align:right"><p>One word represented as feature vector</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Keys</p></td>
<td><p>2</p></td>
<td><p>(sequence length, # of attn features)</p></td>
<td><p>used to compute attention against query</p></td>
<td class="text-align:right"><p>All words in sentence represented as matrix of feature vectors</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Values</p></td>
<td><p>2</p></td>
<td><p>(sequence length, # of value features)</p></td>
<td><p>used to compute value of output</p></td>
<td class="text-align:right"><p>A vector of numbers for each word in a sentence</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Output</p></td>
<td><p>1</p></td>
<td><p>(# of value features)</p></td>
<td><p>attention-weighted mean over values</p></td>
<td class="text-align:right"><p>single vector</p></td>
</tr>
</tbody>
</table>
<div class="section" id="example">
<h2><span class="section-number">4.1. </span>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Attention is best conceptualized as operating on a sequence. Let’s use a sentence like “The sleepy child reads a book”. The words in the sentence correspond to the keys. If we represent our words as embeddings, our keys will be rank 2. For example, the word “sleepy” might be represented by an embedding vector of length 2: <span class="math notranslate nohighlight">\([-0.2, 0.4]\)</span>, where these embedding values are trained or taken from a standard language embedding. By convention, the zeroth axis of keys will be the position in the sequence and the first axis contains these vectors. The query is often an element from the keys, like the word “book”. The point of attention is to see what parts of the sentence the query should be influenced by. “Book” should have strong attention on “child” and “reads”, but probably not to “sleepy”. You’ll see soon that we will actually compute this as a vector, called the attention vector <span class="math notranslate nohighlight">\(\vec{b}\)</span>. The output from the attention layer will be a reduction over the values where each element of values is weighted by the attention between the query and the key. Thus there should be one key and one value for each element in our sentence. The values could be identical to the keys, which is common.</p>
<p>Let’s see how this looks mathematically. The attention layer consists of two steps: (1) computing the attention vector <span class="math notranslate nohighlight">\(\vec{b}\)</span> using the <strong>attention mechanism</strong> and (2) the reduction over the values using the attention vector <span class="math notranslate nohighlight">\(\vec{b}\)</span>. Attention mechanism is a fancy word for the attention equation. Consider our example above. We’ll use a 3 dimensional embedding for our words</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Keys and queries as one-hot encodings will not work as inputs to attention layers because the dot product will give zeros, unless the key and query are equal.</p>
</div>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Index</p></th>
<th class="text-align:center head"><p>Embedding</p></th>
<th class="text-align:right head"><p>Word</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>0</p></td>
<td class="text-align:center"><p>0,0,0</p></td>
<td class="text-align:right"><p>The</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>1</p></td>
<td class="text-align:center"><p>2,0,1</p></td>
<td class="text-align:right"><p>Sleepy</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>2</p></td>
<td class="text-align:center"><p>1,-1,-2</p></td>
<td class="text-align:right"><p>Child</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>3</p></td>
<td class="text-align:center"><p>2,3,1</p></td>
<td class="text-align:right"><p>Reads</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>4</p></td>
<td class="text-align:center"><p>-2,0,0</p></td>
<td class="text-align:right"><p>A</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>5</p></td>
<td class="text-align:center"><p>0,2,1</p></td>
<td class="text-align:right"><p>Book</p></td>
</tr>
</tbody>
</table>
<p>The keys will be a rank 2 tensor (matrix) putting all these together. Note that these are only integers to make this example clearner, typically words are represented with floating point numbers when embedded.</p>
<div class="amsmath math notranslate nohighlight" id="equation-f484fd3f-932f-49f1-a1e5-bd769cdd6f8a">
<span class="eqno">(4.1)<a class="headerlink" href="#equation-f484fd3f-932f-49f1-a1e5-bd769cdd6f8a" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\mathbf{K} = \left[
\begin{array}{lccccr}
0 &amp; 2 &amp; 1 &amp; 2 &amp; -2 &amp; 0\\
0 &amp; 0 &amp; -1 &amp; 3 &amp; 0 &amp; 2\\
0 &amp; 1 &amp; -2 &amp; 1 &amp; 0 &amp; 1\\
\end{array}\right]
\end{equation}\]</div>
<p>They keys are shape <span class="math notranslate nohighlight">\((6, 3)\)</span> because our sentence has 6 words and each word is represented with a 3 dimensional embedding vector. Let’s make our values simple, we’ll have one for each word. These values are what determine our output. Perhaps they could be the sentiment of the word: is it a positive word (happy) or a negative word (angry).</p>
<div class="amsmath math notranslate nohighlight" id="equation-39d80b10-9685-41fa-884b-1fbf23fe0bb9">
<span class="eqno">(4.2)<a class="headerlink" href="#equation-39d80b10-9685-41fa-884b-1fbf23fe0bb9" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\mathbf{V} = \left[ 0, -0.2, 0.3, 0.4, 0, 0.1\right]
\end{equation}\]</div>
<p>Note that the values <span class="math notranslate nohighlight">\(\mathbf{V}\)</span> should be the same rank as the keys, so its shape is interpreted as <span class="math notranslate nohighlight">\((6, 1)\)</span>. Finally, the query which should be one rank less than the keys. Our query is the word “book”:</p>
<div class="amsmath math notranslate nohighlight" id="equation-cb3cf943-b0ca-4430-b2e2-63fa35f01e8b">
<span class="eqno">(4.3)<a class="headerlink" href="#equation-cb3cf943-b0ca-4430-b2e2-63fa35f01e8b" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{q} = \left[0, 2, 1\right]
\end{equation}\]</div>
</div>
<div class="section" id="attention-mechanism-equation">
<h2><span class="section-number">4.2. </span>Attention Mechanism Equation<a class="headerlink" href="#attention-mechanism-equation" title="Permalink to this headline">¶</a></h2>
<p>The first equation is the attention mechanism. This uses query and keys arguments only. It outputs a tensor one rank less than the keys, giving a scalar for each key corresponding to the attention the query should have for the key. The attention vector should be normalized! Usually this is achieved by doing a softmax. The specific equation used is a hyperparameter, like activation functions. In practice, most use a dot product followed by a softmax:</p>
<div class="amsmath math notranslate nohighlight" id="equation-a629c26b-415e-4502-bb64-2ab89963b66b">
<span class="eqno">(4.4)<a class="headerlink" href="#equation-a629c26b-415e-4502-bb64-2ab89963b66b" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{b} = \mathrm{softmax}\left(\vec{q}\cdot \mathbf{K}\right) = \mathrm{softmax}\left(\sum_j q_j k_{ij}\right)
\end{equation}\]</div>
<p>where there could be more indices depending on the rank of the inputs. What we’re doing is taking the dot product of each key with the query. In our example, this would be:</p>
<div class="amsmath math notranslate nohighlight" id="equation-7505e884-c042-4407-a4d1-5a25970fd4f0">
<span class="eqno">(4.5)<a class="headerlink" href="#equation-7505e884-c042-4407-a4d1-5a25970fd4f0" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{b} = \mathrm{softmax}\left(\left[0, 2, 1\right] \times
\left[
\begin{array}{lccccr}
0 &amp; 2 &amp; 1 &amp; 2 &amp; -2 &amp; 0\\
0 &amp; 0 &amp; -1 &amp; 3 &amp; 0 &amp; 2\\
0 &amp; 1 &amp; -2 &amp; 1 &amp; 0 &amp; 1\\
\end{array}\right]\right) = \mathrm{softmax}\left( \left[0, 1, -4, 7, 0, 5\right]\right)
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-eb826a86-4887-4590-a623-8b6ee5ac2257">
<span class="eqno">(4.6)<a class="headerlink" href="#equation-eb826a86-4887-4590-a623-8b6ee5ac2257" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{b}  = \left[0, 0, 0, 0.88, 0, 0.12\right]
\end{equation}\]</div>
<p>I’ve rounded the numbers here, but essentially the attention vector only gives weigth to the word itself (book) and the verb “read”. I made this up, remember, but it gives you an idea of how attention gives you a way to connect words. It may even remind you of our graph neural network’s idea of neighbors.</p>
</div>
<div class="section" id="attention-reduction">
<h2><span class="section-number">4.3. </span>Attention Reduction<a class="headerlink" href="#attention-reduction" title="Permalink to this headline">¶</a></h2>
<p>After computing the attention vector <span class="math notranslate nohighlight">\(\vec{b}\)</span>, this is used to compute a weighted mean over the values. The output of the attention layer is then</p>
<div class="amsmath math notranslate nohighlight" id="equation-7deff1ac-dadf-4226-bbd2-c6d334dca060">
<span class="eqno">(4.7)<a class="headerlink" href="#equation-7deff1ac-dadf-4226-bbd2-c6d334dca060" title="Permalink to this equation">¶</a></span>\[\begin{equation}
 \mathbf{V}\vec{b} = \left[0, 0, 0, 0.88, 0, 0.12\right]^ T \left[ 0, -0.2, 0.3, 0.4, 0, 0.1\right] = 0.36
\end{equation}\]</div>
<p>Conceptually, our example computed the attention-weighted sentiment of the query word “book” in our sentence. You can see that attention layers do two things: compute an attention vector with the attention mechanism and then use it to take the attention-weighted average over the values.</p>
</div>
<div class="section" id="soft-vs-hard-attention">
<h2><span class="section-number">4.4. </span>Soft vs Hard Attention<a class="headerlink" href="#soft-vs-hard-attention" title="Permalink to this headline">¶</a></h2>
<p>Just like activation, there is an enormous range of choices for attention mechanism. One distinguishing attribute is if the softmax is used or a “hardmax”. Recall a softmax converts real numbers into probabilities by viewing the real numbers as log-odds (logs of probability ratios). A “hardmax” means just taking the max, but the ouput is shaped like a probability distribution. Using <strong>hard attention</strong> means that you only return the value which had the maximum output from the attention mechanism, instead of taking a weighted average. You can view this is as just another attention mechanism type, but you’ll see some literature discussing hard vs soft attention.</p>
</div>
<div class="section" id="tensor-dot">
<h2><span class="section-number">4.5. </span>Tensor-Dot<a class="headerlink" href="#tensor-dot" title="Permalink to this headline">¶</a></h2>
<p>The most common attention mechanism is a dot product (called tensor-dot to be more general) followed by a softmax <a class="bibtex reference internal" href="layers.html#luong2015effective" id="id5">[LPM15]</a>. This is divided by the dimension of the keys (last axis dimension). Rememebr the keys are not normalized. If they are random numbers, the magnitude of the output from the dot product scales with the square root of the dimension of the keys due to the central limit theorem. This can make the soft-max behave poorly, since you’re taking <span class="math notranslate nohighlight">\(e^{\vec{q} \cdot \mathbf{K}}\)</span>. Putting this all together, the equation is:</p>
<div class="amsmath math notranslate nohighlight" id="equation-33ac2ff9-af4c-4f62-8f47-ecb24c2544ee">
<span class="eqno">(4.8)<a class="headerlink" href="#equation-33ac2ff9-af4c-4f62-8f47-ecb24c2544ee" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \vec{b} = \mathrm{softmax}\left(\frac{1}{\sqrt{d}}\vec{q}\cdot \mathbf{K}\right)
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(d\)</span> is the dimension of the query vector.</p>
</div>
<div class="section" id="self-attention">
<h2><span class="section-number">4.6. </span>Self-Attention<a class="headerlink" href="#self-attention" title="Permalink to this headline">¶</a></h2>
<p>Remember how everything is batched in deep learning? The batched input to an attention layer is usually the query. So although in the above discussion it was a tensor of one rank less than the keys (typically a query <em>vector</em>), once it has been batched it will be the same rank as the keys. Almost always, the query is in fact equal to the keys. Like in our example, our query was the emebdding vector for the word “book”, which is one of the keys. If you consider the query to be batched so that you consider every word in the sentence, the query becomes equal to the keys. A further special case is when the query, values and keys are equal. This is called <strong>self-attention</strong>. This just means our attention mechanism uses the values directly and there is no extra set of “keys” input to the layer.</p>
</div>
<div class="section" id="trainable-attention">
<h2><span class="section-number">4.7. </span>Trainable Attention<a class="headerlink" href="#trainable-attention" title="Permalink to this headline">¶</a></h2>
<p>There are no trainable parameters in our definitions above yet. How can you do learning with attention? Typically, you don’t. There are exceptions like using a trainable attention mechanism (like a dense layer), but in most definitions of attention you do not have any trainable parameters.</p>
</div>
<div class="section" id="multi-head-attention-block">
<h2><span class="section-number">4.8. </span>Multi-head Attention Block<a class="headerlink" href="#multi-head-attention-block" title="Permalink to this headline">¶</a></h2>
<p>Inspired by the idea of convolutions with multiple filters, there is a block (group of layers) that splits to multiple parallel attentions.  These are called “multi-head attention”. If your values are shape <span class="math notranslate nohighlight">\((L, V)\)</span>, you will get back a <span class="math notranslate nohighlight">\((H, V)\)</span> tensor, where <span class="math notranslate nohighlight">\(H\)</span> is the number of parallel attention layers (heads). If there are no trainable parameters in attention layers, what’s the point of this though? Well you must introduce weights. These are <em>square</em> weight matrices because we need all shapes to remain constant among all the attention heads.</p>
<p>Consider an attention layer to be defined by <span class="math notranslate nohighlight">\(A(\vec{q}, \mathbf{K}, \mathbf{V})\)</span>. The multiheaded attention is</p>
<div class="amsmath math notranslate nohighlight" id="equation-89b9b803-8c71-4636-ad9d-67b60197a0c9">
<span class="eqno">(4.9)<a class="headerlink" href="#equation-89b9b803-8c71-4636-ad9d-67b60197a0c9" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\left[A(\mathbf{W}_q^0\vec{q}, \mathbf{W}_k^0\mathbf{K}, \mathbf{W}_v^1\mathbf{V}), A(\mathbf{W}_q^1\vec{q}, \mathbf{W}_k^1\mathbf{K}, \mathbf{W}_v^1\mathbf{V}), \ldots, A(\mathbf{W}_q^H\vec{q}, \mathbf{W}_k^H\mathbf{K}, \mathbf{W}_v^H\mathbf{V})\right]
\end{equation}\]</div>
<p>where each element of the output vector <span class="math notranslate nohighlight">\([\ldots]\)</span> is itself an output vector from an attention layer, making the <span class="math notranslate nohighlight">\((L, V)\)</span> shaped tensor. So the whole output is an <span class="math notranslate nohighlight">\((H, L, V)\)</span> tensor. The most famous example of the mult-head attention block is in transformers<a class="bibtex reference internal" href="layers.html#vaswani2017attention" id="id6">[VSP+17]</a> where they use self-attention mult-ahead attention blocks.</p>
<p>Typically the next layer doesn’t expect an <span class="math notranslate nohighlight">\((H, L, V)\)</span> tensor, so the output from the mult-headed attention is often reduced by multiplying with an <span class="math notranslate nohighlight">\((H, V, V)\)</span> or <span class="math notranslate nohighlight">\((H)\)</span> tensor of weights.</p>
</div>
<div class="section" id="attention-in-graph-neural-networks">
<h2><span class="section-number">4.9. </span>Attention in Graph Neural Networks<a class="headerlink" href="#attention-in-graph-neural-networks" title="Permalink to this headline">¶</a></h2>
<p>Recall that the key attribute of a graph neural network is permutation invariance. We used reductions like sum or mean over neighbors as the way to make the graph neural network layers be permutation invariant. Attention layers are also permutation invariant! This has made attention a popular choice for how to aggregate neighbor information. Attention layers are good at finding important neighbors and so are imporant with high-degree graphs (lots of neighbors). This is rare in molecules, but you can just define all atoms to be connected and then put distances as the edge attributes. Recall that graph convolution layers (GCN layer), and most GNN layers, only allow infomration to propogate one-bond per layer. Thus joining all atoms and using attention can give you long-range communication without so many layers. The disadvantage is that your network must now learn this, so perhaps you can reduce model bias but at the cost of requiring more training data/having more model variance.</p>
<p>Let’s see how attention fits into the Battaglia equations<a class="bibtex reference internal" href="layers.html#battaglia2018relational" id="id7">[BHB+18]</a>. Recall that the Battaglia equations are general standard equations for defining a GNN. Attention can appear in multiple places, but as discussed above it appears when considering neighbors. Specifically, the query will be the <span class="math notranslate nohighlight">\(i\)</span>th node, and the keys/values will be some combination of neighboring node and edge features. There is no step in the Battaglia equations where this fits neatly, but we can split up the attention layer as follows. Most of the attention layer will fit into the edge update equation:</p>
<div class="amsmath math notranslate nohighlight" id="equation-6323efc5-b581-45f9-ab9f-88179eb7e5d5">
<span class="eqno">(4.10)<a class="headerlink" href="#equation-6323efc5-b581-45f9-ab9f-88179eb7e5d5" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{e}^{'}_k = \phi^e\left( \vec{e}_k, \vec{v}_{rk}, \vec{v}_{sk}, \vec{u}\right)
\end{equation}\]</div>
<p>Recall that this is a general equation and our choice of <span class="math notranslate nohighlight">\(\phi^e()\)</span> defines the GNN. <span class="math notranslate nohighlight">\(\vec{e}_k\)</span> is the feature vector of edge <span class="math notranslate nohighlight">\(k\)</span>, <span class="math notranslate nohighlight">\(\vec{v}_{rk}\)</span> is the receiving node feature vector for edge <span class="math notranslate nohighlight">\(k\)</span>, <span class="math notranslate nohighlight">\(\vec{v}_{sk}\)</span> is the sending node feature vector for edge <span class="math notranslate nohighlight">\(k\)</span>, <span class="math notranslate nohighlight">\(\vec{u}\)</span> is the global graph feature vector. We will use this step for attention mechanism where the query is the receiving node <span class="math notranslate nohighlight">\(\vec{v}_{rk}\)</span> and the keys/values are composed of the senders and edges vectors. To be specific, we’ll use the approach from Zhang et al. <a class="bibtex reference internal" href="layers.html#zhang2018gaan" id="id8">[ZSX+18]</a> with a tensor-dot mechanism. They only considered node features and set the keys and values to be identical as the node features. However, they put trainable parameters at each layer that translated the node features in to the keys/query.</p>
<div class="amsmath math notranslate nohighlight" id="equation-ce8b7467-2f9d-4c0d-bef6-be5b50b84ee9">
<span class="eqno">(4.11)<a class="headerlink" href="#equation-ce8b7467-2f9d-4c0d-bef6-be5b50b84ee9" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{q} = \mathbf{W}_q\vec{v}_{rk}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-cfa15e5d-7002-43a4-af92-6cadc200f6e3">
<span class="eqno">(4.12)<a class="headerlink" href="#equation-cfa15e5d-7002-43a4-af92-6cadc200f6e3" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\mathbf{K} = \mathbf{W}_k\vec{v}_{sk}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-a3709da7-b1b4-4f6e-b303-42a747309ab9">
<span class="eqno">(4.13)<a class="headerlink" href="#equation-a3709da7-b1b4-4f6e-b303-42a747309ab9" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\mathbf{V} = \mathbf{W}_v\vec{v}_{sk}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-e383342a-74e4-4668-81d5-a275f27f1df1">
<span class="eqno">(4.14)<a class="headerlink" href="#equation-e383342a-74e4-4668-81d5-a275f27f1df1" title="Permalink to this equation">¶</a></span>\[\begin{equation}
    \vec{b}_k = \mathrm{softmax}\left(\frac{1}{\sqrt{d}} \vec{q}\cdot \mathbf{K}\right)
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-d690fec8-c967-4d1e-b458-3e70c1604483">
<span class="eqno">(4.15)<a class="headerlink" href="#equation-d690fec8-c967-4d1e-b458-3e70c1604483" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{e}^{'}_k = \vec{b} V
\end{equation}\]</div>
<p>Putting it compactly into one equation:</p>
<div class="amsmath math notranslate nohighlight" id="equation-f0df9d1c-40f0-4fcf-877e-5b970cfc38be">
<span class="eqno">(4.16)<a class="headerlink" href="#equation-f0df9d1c-40f0-4fcf-877e-5b970cfc38be" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\vec{e}^{'}_k = \mathrm{softmax}\left(\frac{1}{\sqrt{d}} \mathbf{W}_q\vec{v}_{rk}\cdot \mathbf{W}_k\vec{v}_{sk}\right)\mathbf{W}_v\vec{v}_{sk}
\end{equation}\]</div>
<p>Now we have weighted edge feature vectors from the attention. Finally, we sum over these edge features in the edge aggregation step.</p>
<div class="amsmath math notranslate nohighlight" id="equation-b7ecc6d0-925b-4b1a-8aff-48cd99d1cb03">
<span class="eqno">(4.17)<a class="headerlink" href="#equation-b7ecc6d0-925b-4b1a-8aff-48cd99d1cb03" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\bar{e}^{'}_i = \rho^{e\rightarrow v}\left( E_i^{'}\right) = \sum E_i^{'}
\end{equation}\]</div>
<p>In Zhang et al. <a class="bibtex reference internal" href="layers.html#zhang2018gaan" id="id9">[ZSX+18]</a>, they used mult-headed attention as well. How would multi-headed attention work? Your edge feature matrix <span class="math notranslate nohighlight">\( E_i^{'}\)</span> now becomes an edge feature tensor, where axis 0 is edge (<span class="math notranslate nohighlight">\(k\)</span>), axis 1 is feature, and axis 2 is the head. Recall that the “head” just means which set of <span class="math notranslate nohighlight">\(\mathbf{W}^h_q, \mathbf{W}^h_k, \mathbf{W}^h_v\)</span> we used. To reduce the tensor back to the expected matrix, we simply use another weight matrix that maps from the last two axes (feature, head) down to features only. I will write-out the indices explicitly to be more clear:</p>
<div class="amsmath math notranslate nohighlight" id="equation-f31c107e-a746-4cf3-9233-ca6dd951ece5">
<span class="eqno">(4.18)<a class="headerlink" href="#equation-f31c107e-a746-4cf3-9233-ca6dd951ece5" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\bar{e}^{'}_{il} = \rho^{e\rightarrow v}\left( E_i^{'}\right) = \sum_k e_{ikjh}^{'}w_{jhl}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(j\)</span> is edge feature input index, <span class="math notranslate nohighlight">\(l\)</span> is our output edge feature matrix, and <span class="math notranslate nohighlight">\(k,h,i\)</span> are defined as before.</p>
</div>
<div class="section" id="cited-references">
<h2><span class="section-number">4.10. </span>Cited References<a class="headerlink" href="#cited-references" title="Permalink to this headline">¶</a></h2>
<p id="bibtex-bibliography-dl/attention-0"><dl class="citation">
<dt class="bibtex label" id="baluja1997329"><span class="brackets"><a class="fn-backref" href="#id1">BP97</a></span></dt>
<dd><p>Shumeet Baluja and Dean A. Pomerleau. Expectation-based selective attention for visual monitoring and control of a robot vehicle. <em>Robotics and Autonomous Systems</em>, 22(3):329 – 344, 1997. Robot Learning: The New Wave. URL: <a class="reference external" href="http://www.sciencedirect.com/science/article/pii/S0921889097000468">http://www.sciencedirect.com/science/article/pii/S0921889097000468</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/S0921-8890(97)00046-8">doi:https://doi.org/10.1016/S0921-8890(97)00046-8</a>.</p>
</dd>
<dt class="bibtex label" id="battaglia2018relational"><span class="brackets"><a class="fn-backref" href="#id7">BHB+18</a></span></dt>
<dd><p>Peter W Battaglia, Jessica B Hamrick, Victor Bapst, Alvaro Sanchez-Gonzalez, Vinicius Zambaldi, Mateusz Malinowski, Andrea Tacchetti, David Raposo, Adam Santoro, Ryan Faulkner, and others. Relational inductive biases, deep learning, and graph networks. <em>arXiv preprint arXiv:1806.01261</em>, 2018.</p>
</dd>
<dt class="bibtex label" id="luong2015effective"><span class="brackets">LPM15</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id5">2</a>)</span></dt>
<dd><p>Minh-Thang Luong, Hieu Pham, and Christopher D Manning. Effective approaches to attention-based neural machine translation. <em>arXiv preprint arXiv:1508.04025</em>, 2015.</p>
</dd>
<dt class="bibtex label" id="treisman1980feature"><span class="brackets"><a class="fn-backref" href="#id2">TG80</a></span></dt>
<dd><p>Anne M Treisman and Garry Gelade. A feature-integration theory of attention. <em>Cognitive psychology</em>, 12(1):97–136, 1980.</p>
</dd>
<dt class="bibtex label" id="vaswani2017attention"><span class="brackets">VSP+17</span><span class="fn-backref">(<a href="#id4">1</a>,<a href="#id6">2</a>)</span></dt>
<dd><p>Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N Gomez, Łukasz Kaiser, and Illia Polosukhin. Attention is all you need. In <em>Advances in neural information processing systems</em>, 5998–6008. 2017.</p>
</dd>
<dt class="bibtex label" id="zhang2018gaan"><span class="brackets">ZSX+18</span><span class="fn-backref">(<a href="#id8">1</a>,<a href="#id9">2</a>)</span></dt>
<dd><p>Jiani Zhang, Xingjian Shi, Junyuan Xie, Hao Ma, Irwin King, and Dit-Yan Yeung. Gaan: gated attention networks for learning on large and spatiotemporal graphs. <em>arXiv preprint arXiv:1803.07294</em>, 2018.</p>
</dd>
</dl>
</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./dl"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="gnn.html" title="previous page"><span class="section-number">3. </span>Graph Neural Networks</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Andrew D. White<br/>
        
            &copy; Copyright 2020.<br/>
          <div class="extra_footer">
            <a href="http://thewhitelab.org">thewhitelab.org</a> <div id="wh-modal"> <button class="wh-venti-button" aria-label="close modal" id="wh-modal-close">✕</button> <img id="wh-modal-img"> </div>
          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>